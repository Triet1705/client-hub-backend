#!/bin/bash
#
# ============================================================================
# PRE-COMMIT HOOK - SECRET SCANNING (Client Hub Project)
# ============================================================================
# Related Tasks: CHDEV-24, CHDEV-26, CHDEV-27
# Purpose: Prevent committing sensitive files and cryptographic secrets
# Tech Stack: Java Spring Boot + Web3j + Solidity Smart Contracts
# ============================================================================

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo -e "${YELLOW}[Security] üõ°Ô∏è  Scanning staged files for secrets...${NC}"

# Get staged files (Added, Copied, Modified)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No files staged for commit${NC}"
    exit 0
fi

FORBIDDEN=0
WARNING=0

# ============================================================================
# SECTION 1: FILE EXTENSION BLOCKING (CRITICAL - HARD BLOCK)
# ============================================================================
echo -e "${YELLOW}üìÅ Checking file extensions...${NC}"

# Block actual .env files but allow .env.example and .env.template
SENSITIVE_EXTENSIONS='(\.env$|\.env\.local$|\.env\.development$|\.env\.production$|\.env\.staging$|\.key$|\.pem$|\.p12$|\.jks$|\.pfx$|\.secret$|application-prod\.properties|application-production\.properties)'

for file in $STAGED_FILES; do
    # Skip hook files themselves and lock files
    if [[ "$file" == *".githooks/"* ]] || [[ "$file" == *"package-lock.json"* ]] || [[ "$file" == *"yarn.lock"* ]]; then
        continue
    fi
    
    # Allow .env.example and .env.template (template files are safe to commit)
    if [[ "$file" == *".env.example"* ]] || [[ "$file" == *".env.template"* ]]; then
        continue
    fi
    
    if echo "$file" | grep -qE "$SENSITIVE_EXTENSIONS"; then
        echo -e "${RED}[BLOCK] ‚ùå Forbidden file type: $file${NC}"
        echo -e "${YELLOW}   ‚Üí This file type should NEVER be committed${NC}"
        FORBIDDEN=1
    fi
done

# ============================================================================
# SECTION 2: CRYPTO SECRETS DETECTION (WEB3 SPECIFIC - HARD BLOCK)
# ============================================================================
echo -e "${YELLOW}üîê Scanning for cryptographic secrets...${NC}"

for file in $STAGED_FILES; do
    # Skip non-text files and deleted files
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Skip binary files
    if file "$file" | grep -q "executable\|binary"; then
        continue
    fi
    
    # === CHECK 1: Ethereum/Polygon Private Keys (64 hex chars) ===
    # Exclude dummy/zero addresses (0x0000... or test placeholders)
    if grep -E "0x[a-fA-F0-9]{64}" "$file" | grep -vE "(0x0{64}|YOUR.*KEY|REPLACE|EXAMPLE|TEST.*KEY)"; then
        echo -e "${RED}[BLOCK] ‚ùå Ethereum Private Key detected in: $file${NC}"
        grep -E "0x[a-fA-F0-9]{64}" "$file" | grep -vE "(0x0{64}|YOUR.*KEY|REPLACE|EXAMPLE)" | head -n 1 | cut -c 1-60
        echo -e "${YELLOW}   ‚Üí Remove the private key and use environment variables${NC}"
        FORBIDDEN=1
    fi
    
    # === CHECK 2: PEM-encoded Private Keys ===
    if grep -q "BEGIN.*PRIVATE KEY" "$file"; then
        echo -e "${RED}[BLOCK] ‚ùå PEM Private Key header detected in: $file${NC}"
        echo -e "${YELLOW}   ‚Üí PEM files should be in .gitignore, not committed${NC}"
        FORBIDDEN=1
    fi
    
    # === CHECK 3: Base64 Encoded Keys (MC4w prefix) ===
    if grep -q "MC4w" "$file"; then
        echo -e "${RED}[BLOCK] ‚ùå Potential Base64 Encoded Key (MC4w) in: $file${NC}"
        echo -e "${YELLOW}   ‚Üí This pattern often indicates encoded private keys${NC}"
        FORBIDDEN=1
    fi
    
    # === CHECK 4: Hardcoded 'private_key' assignments ===
    if grep -iE "private_key\s*[:=]\s*['\"]?[a-zA-Z0-9]{10,}" "$file" | grep -vE "(YOUR.*KEY|REPLACE|EXAMPLE|TODO)"; then
        echo -e "${RED}[BLOCK] ‚ùå Hardcoded 'private_key' variable in: $file${NC}"
        echo -e "${YELLOW}   ‚Üí Use environment variables: \${ADMIN_WALLET_KEY}${NC}"
        FORBIDDEN=1
    fi
done

# ============================================================================
# SECTION 3: GENERIC SECRETS DETECTION (WARNING + INTERACTIVE)
# ============================================================================
echo -e "${YELLOW}üîç Scanning for generic secrets patterns...${NC}"

# Only scan code files (not images, videos, archives) and EXCLUDE test files
CODE_FILES=$(echo "$STAGED_FILES" | grep -E '\.(java|properties|yml|yaml|xml|ts|tsx|js|jsx|sol|json)$' | grep -vE '(Test\.(java|ts)|\.test\.(js|ts)|\.spec\.(js|ts)|/test/|/tests/)' || true)

if [ -n "$CODE_FILES" ]; then
    # Generic secret patterns (password, token, api_key, etc.)
    SECRET_PATTERNS="(password|passwd|pwd|secret|token|api[_-]?key|access[_-]?key|auth[_-]?token|bearer|credential|mnemonic|seed[_-]?phrase)\s*[:=]\s*['\"][^'\"]{8,}"
    
    for file in $CODE_FILES; do
        if [ ! -f "$file" ]; then
            continue
        fi
        
        # Check added lines only (grep for +) and exclude test patterns and safe password masking
        MATCHES=$(git diff --cached "$file" | grep -E "^\+" | grep -iE "$SECRET_PATTERNS" | grep -vE "(TODO|FIXME|EXAMPLE|YOUR_.*_HERE|REPLACE_ME|TEST_SECRET|TEST_TOKEN|MOCK_|\[PROTECTED\]|\*\*\*\*)" || true)
        
        if [ -n "$MATCHES" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  WARNING: Potential secret pattern in $file${NC}"
            echo "$MATCHES" | head -3 | sed 's/^/   /'
            WARNING=1
        fi
    done
fi

# ============================================================================
# SECTION 4: HARDCODED URLs/IPs WARNING (SOFT WARNING)
# ============================================================================
HARDCODED_IPS=$(git diff --cached | grep -E "^\+" | grep -oE "(http://|https://)[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+" || true)
if [ -n "$HARDCODED_IPS" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  INFO: Hardcoded IP addresses found:${NC}"
    echo "$HARDCODED_IPS" | sort -u | sed 's/^/   /'
    echo -e "${YELLOW}   ‚Üí Consider using Spring properties: \${BLOCKCHAIN_NODE_URL}${NC}"
fi

# ============================================================================
# FINAL DECISION LOGIC
# ============================================================================

if [ $FORBIDDEN -eq 1 ]; then
    echo ""
    echo -e "${RED}======================================================${NC}"
    echo -e "${RED}‚õî COMMIT REJECTED: Critical secrets detected!${NC}"
    echo -e "${RED}======================================================${NC}"
    echo -e "${YELLOW}Required actions:${NC}"
    echo -e "  1. Remove secrets from files"
    echo -e "  2. Add sensitive files to .gitignore"
    echo -e "  3. Use environment variables (\${ADMIN_WALLET_KEY})"
    echo -e "  4. Refer to Tech Docs Section 9.3 (Secrets Management)"
    echo ""
    echo -e "${YELLOW}Emergency bypass (NOT RECOMMENDED):${NC}"
    echo -e "  git commit --no-verify -m \"your message\""
    echo -e "${RED}======================================================${NC}"
    exit 1
fi

if [ $WARNING -eq 1 ]; then
    echo ""
    echo -e "${YELLOW}‚ö†Ô∏è  Warnings detected. Please review carefully.${NC}"
    echo -e "${YELLOW}Consider using:${NC}"
    echo -e "  ‚Ä¢ Environment variables in .env (add to .gitignore)"
    echo -e "  ‚Ä¢ Spring Cloud Config / Azure Key Vault"
    echo -e "  ‚Ä¢ application-{profile}.properties (ignored files)"
    echo ""
    read -p "Do you want to continue anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo -e "${RED}Commit cancelled by user${NC}"
        exit 1
    fi
fi

echo ""
echo -e "${GREEN}‚úÖ Security Scan Passed. Proceeding with commit...${NC}"
exit 0
